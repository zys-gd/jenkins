node ('master') {
	dir ("/var/lib/jenkins/workspace/B2C image builder") {
		sh 'ls -la docker'
		stash name: "docker", includes: "docker/", allowEmpty: true
	}
}

pipeline {
	agent { node { label 'toplivo-stage' } }
	options {
		skipDefaultCheckout true
	}
	environment {
		def DOCKER_USERNAME='jenkins'
        def DOCKER_PASSWORD='ch1qySOXu8Q'
        def DOCKER_REGISTRY='jf-dev.toplyvo.app'
    }
	parameters {
        gitParameter name: 'TAG',
                     type: 'PT_TAG',
                     defaultValue: 'v2.0.0',
                     description: 'Tag og docker image\'s build',
                     quickFilterEnabled: true,
                     sortMode: 'DESCENDING_SMART',
                     useRepository: 'git@github.com:transloyd/core.toplyvo.app.git'

    }
	stages {

		stage ('Get build configuration') {
			steps {
				buildDescription "${params.TAG}"
				script { try {
					// this checkout is needed for gitParameter plugin
					checkout([
						$class: 'GitSCM',
						branches: [[name: '*/master']],
						doGenerateSubmoduleConfigurations: false,
						extensions: [
							[$class: 'RelativeTargetDirectory', relativeTargetDir: 'source']
						],
						submoduleCfg: [],
						userRemoteConfigs: [[
							credentialsId: '7303d04c-541b-49a3-83f2-834b64810cc5',
							url: 'git@github.com:transloyd/core.toplyvo.app.git'
						]]
					])
					sh 'rm -rf source docker environments'
				} catch (exc) {}}
				unstash "docker"
			}
		}



	}
}